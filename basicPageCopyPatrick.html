<html>

<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">

	<!-- we want to use D3, so this is where the D3 library version 5 gets called-->
	<script src="https://d3js.org/d3.v5.js"></script>
	<link href="style.css" rel="stylesheet">

	<!--title of the webpage-->
	<title>Illegal Cheetah Trade</title>

</head>

<body>
	<!-- simple text heading-->
	<h1>Illegal Cheetah Trade</h1>

	<!-- Create a div where the graph will take place -->
	<div id="visualisation">
		<div id="bar_region"></div>
		<div id="line"> </div>
		<div id="lolli"> </div>
	</div>

	<script>
		var dataPath = "data/Tricorache_et_al_Global_trade_dataset_for_cheetah.csv"; // our data file	

		// parse the date / time
		var parseTime = d3.timeParse("%d-%b-%y");

		// Get the data
		d3.csv(dataPath).then(function (data) {
			// format the data
			data.forEach(function (d) {
				d.Incident_Date = parseTime(d.Incident_Date); //Change to Date
				d.Cheetahs_Number = +d.Cheetahs_Number; //change to int
				d.Cheetahs_Number = isNaN(d.Cheetahs_Number) ? null : d.Cheetahs_Number; // Change to null if it's not an integer
				d.Alive = +d.Alive;
				d.Alive = isNaN(d.Alive) ? null : d.Alive;
				d.Died = +d.Died;
				d.Died = isNaN(d.Died) ? null : d.Died;
			});

			/*Bar Chart - Start- https://github.com/kriscfoster/d3-barchart*/

			// Group and count instances by region 
			const data_bar = d3.nest()
				.key(function (d) { return d.Region; })
				.rollup(function (v) { return v.length; })
				.entries(data);

			const margin_bar = { top: 10, right: 40, bottom: 60, left: 40 };
			const width_bar = 850;
			const height_bar = 400;

			const bar_svg = d3.select('#bar_region')
				.append('svg')
				.attr('width', width_bar - margin_bar.left - margin_bar.right)
				.attr('height', height_bar - margin_bar.top - margin_bar.bottom)
				.attr("viewBox", [0, 0, width_bar, height_bar]);

			const bar_x = d3.scaleBand()
				.domain(d3.range(data_bar.length))
				.range([margin_bar.left, width_bar - margin_bar.right])
				.padding(0.1)

			const bar_y = d3.scaleLinear()
				.domain([0, d3.max(data_bar, function (d) { return d.value; })])
				.range([height_bar - margin_bar.bottom, margin_bar.top])

			bar_svg.append("g")
				.attr("fill", 'green')
				.selectAll("rect")
				.data(data_bar.sort((a, b) => d3.descending(a.value, b.value)))
				.join("rect")
				.on("mouseover", function(d){
					d3.select("svg")
					.append("text")
					.attr("class", "tooltip")
					.text(d.value +" incidents")
					.attr("x", bar_x(parseFloat(d.key))-5)
					.attr("y", bar_y(parseFloat(d.value)-5)
								  	  );
				})
				.on("mouseout",function(d){
						d3.selectAll(".tooltip")
						.remove();
								})
				.attr("x", (d, i) => bar_x(i))
				.attr("y", d => bar_y(d.value))
				.attr('title', (d) => d.value)
				.attr("class", "rect")
				.attr("height", d => bar_y(0) - bar_y(d.value))
				.attr("width", bar_x.bandwidth());

			//Add label for x axis
			bar_svg.append("text")
				.attr("class", "x label")
				.attr("text-anchor", "middle")
				.attr("x", (width_bar) / 2)
				.attr("y", (height_bar + margin_bar.top - 20))
				.text("Region by continent");

			//Add label for y axis
			bar_svg.append("text")
				.attr("transform", "rotate(-90)")
				.attr("y", 0 - margin_bar.left)
				.attr("x", 0 - (height_bar / 2))
				.attr("dy", "1em")
				.attr("text-anchor", "middle")
				.text("Incidents")

			//Add title for visualization
			bar_svg.append("h1")
				.attr("x", (width_bar) / 2)
				.attr("y", (height_bar + margin_bar.top + 20))
				.attr("text-anchor", "middle")
				.text("Title");

			function yAxis(g) {
				g.attr("transform", `translate(${margin_bar.left}, 0)`)
					.call(d3.axisLeft(bar_y).ticks(null, data_bar.format))
					.attr("font-size", '20px')
			}

			function xAxis(g) {
				g.attr("transform", `translate(0,${height_bar - margin_bar.bottom})`)
					.call(d3.axisBottom(bar_x).tickFormat(i => data_bar[i].key))
					.attr("font-size", '20px')

			}


			bar_svg.append("g")
				.call(xAxis);
			bar_svg.append("g")
				.call(yAxis);


			bar_svg.node();
			/*Bar Chart - End*/


			/* Line Graph - https://bl.ocks.org/d3noob/daecba427fed7c2d912d8abbe9f3e784 */

			var margin_line = { top: 20, right: 20, bottom: 30, left: 50 },
				width_line = 960 - margin_line.left - margin_line.right,
				height_line = 500 - margin_line.top - margin_line.bottom;

			// define a line (for each data point not grouped)
			/*var valueline = d3.line()
				.defined(function(d) { return d.Cheetahs_Number != null; })  // Ignores null values instead of showing them as 0
				.x(function(d) { return x(d.Incident_Date); })
				.y(function(d) { return y(d.Cheetahs_Number); });*/

			// append the svg obgect to the body of the page
			// appends a 'group' element to 'svg'
			// moves the 'group' element to the top left margin
			var line_svg = d3.select("#line").append("svg")
				.attr("width", width_line + margin_line.left + margin_line.right)
				.attr("height", height_line + margin_line.top + margin_line.bottom)
				.append("g")
				.attr("transform", "translate(" + margin_line.left + "," + margin_line.top + ")");

			// Group by month
			var Cheetahs_NumberTotal = d3.nest()
				.key(d => { return d3.timeMonth(d.Incident_Date); })
				.rollup(value => { return d3.sum(value, d => { return d.Cheetahs_Number; }); })
				.entries(data);
			//console.log(Cheetahs_NumberTotal)

			var DiedTotal = d3.nest()
				.key(d => { return d3.timeMonth(d.Incident_Date); })
				.rollup(value => { return d3.sum(value, d => { return d.Died; }); })
				.entries(data);
			//console.log(DiedTotal)

			var AliveTotal = d3.nest()
				.key(d => { return d3.timeMonth(d.Incident_Date); })
				.rollup(value => { return d3.sum(value, d => { return d.Alive; }); })
				.entries(data);
			//console.log(AliveTotal)

			// set the ranges for the data
			var x = d3.scaleTime().range([0, width_line]);
			var y = d3.scaleLinear().range([height_line, 0]);

			// Scale the range of the data
			x.domain(d3.extent(data, function (d) { return d.Incident_Date; }));
			y.domain([0, d3.max(Cheetahs_NumberTotal, function (d) { return d.value; })]);

			// Create the line
			var valueline4 = d3.line()
				//.defined(function(d) { return d.Cheetahs_Number != null; })  // Ignores null values instead of showing them as 0
				.x(function (d) { return x(new Date(d.key)); })
				.y(function (d) { return y(d.value); });

			// Create the area
			var area = d3.area()
				.x(d => { return x(new Date(d.key)); })
				.y1(d => { return y(d.value); })
				.y0(d => { return y.range()[0]; })


			/*// Add the valueline (not grouped) path.
			svg.append("path")
				.data([data])
				.attr("class", "line")
				.style("stroke", "blue")
				.attr("d", valueline);*/

			// Draw the line for total number of Cheetahs found
			line_svg.append("path")
				.data([Cheetahs_NumberTotal])
				.attr("class", "line")
				.style("stroke", "black")
				.attr("d", valueline4);

			// Draw the areas for total number found dead and alive
			line_svg.append("path")
				.data([DiedTotal])
				.attr("class", "line")
				.style("stroke", "red")
				.style("fill", "red")
				.attr("d", area);

			line_svg.append("path")
				.data([AliveTotal])
				.attr("class", "area")
				.style("stroke", "blue")
				.style("fill", "blue")
				.attr("d", area);

			// Draw the X Axis
			line_svg.append("g")
				.attr("transform", "translate(0," + height_line + ")")
				.call(d3.axisBottom(x));

			// Draw the Y Axis
			line_svg.append("g")
				.call(d3.axisLeft(y));
		});

	</script>
</body>

</html>